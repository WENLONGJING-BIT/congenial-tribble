<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ•¬ä¹¦é˜ - å¼€å¯ä½ çš„é˜…è¯»ä¹‹æ—…</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for elegant typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfaf6;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Noto Serif SC', serif;
        }
        .hero-bg {
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.2)), url('https://images.unsplash.com/photo-1507842217343-583bb7270b66?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        #chat-window::-webkit-scrollbar, #modal-content::-webkit-scrollbar {
            width: 6px;
        }
        #chat-window::-webkit-scrollbar-track, #modal-content::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #chat-window::-webkit-scrollbar-thumb, #modal-content::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 20px;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        html.modal-active {
            overflow: hidden;
        }
        .progress-bar {
            background-color: #f3f3f3;
            border-radius: 10px;
            height: 8px;
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-inner {
            background-color: #f59e0b; /* amber-500 */
            height: 100%;
            width: 0;
            border-radius: 10px;
            transition: width 0.5s ease-out;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #f59e0b;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header & Navigation -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-gray-800">
                <span class="font-serif">ğŸ“š å°æ•¬ä¹¦é˜</span>
            </a>
            <nav class="hidden md:flex space-x-8">
                <a href="#" class="text-gray-600 hover:text-amber-700">é¦–é¡µ</a>
                <a href="#personalized-recs" class="text-gray-600 hover:text-amber-700">ä¸ªæ€§æ¨è</a>
                <a href="#recommendations" class="text-gray-600 hover:text-amber-700">è‡ªåŠ¨æ¨è</a>
                <a href="#notes" class="text-gray-600 hover:text-amber-700">AIè§£è¯»</a>
                <a href="#ai-assistant" class="text-gray-600 hover:text-amber-700">AIåŠ©æ‰‹</a>
            </nav>
            <button class="md:hidden" id="mobile-menu-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
            </button>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4">
             <a href="#" class="block py-2 text-gray-600 hover:text-amber-700">é¦–é¡µ</a>
             <a href="#personalized-recs" class="block py-2 text-gray-600 hover:text-amber-700">ä¸ªæ€§æ¨è</a>
             <a href="#recommendations" class="block py-2 text-gray-600 hover:text-amber-700">è‡ªåŠ¨æ¨è</a>
             <a href="#notes" class="block py-2 text-gray-600 hover:text-amber-700">AIè§£è¯»</a>
             <a href="#ai-assistant" class="block py-2 text-gray-600 hover:text-amber-700">AIåŠ©æ‰‹</a>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Hero Section -->
        <section class="hero-bg text-white">
            <div class="container mx-auto px-6 py-32 md:py-48 text-center md:text-left">
                <h1 class="text-4xl md:text-6xl font-bold leading-tight">å¼€å¯ä½ çš„é˜…è¯»ä¹‹æ—…</h1>
                <p class="mt-4 text-lg md:text-xl max-w-2xl">åœ¨æ–‡å­—çš„æµ·æ´‹ä¸­ï¼Œå‘ç°æœªçŸ¥çš„ä¸–ç•Œï¼Œé‡è§æ›´å¥½çš„è‡ªå·±ã€‚</p>
                <a href="#personalized-recs" class="mt-8 inline-block bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    æ¢ç´¢ä¹¦æµ·
                </a>
            </div>
        </section>

        <!-- AI Personalized Recommendations Section -->
        <section id="personalized-recs" class="py-16 md:py-24 bg-amber-50">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-3xl md:text-4xl font-bold mb-4">âœ¨ AIä¸ªæ€§åŒ–æ¨è</h2>
                <p class="text-gray-600 mb-8 max-w-2xl mx-auto">å‘Šè¯‰æˆ‘ä½ å–œæ¬¢ä»€ä¹ˆï¼ˆæ¯”å¦‚â€œå–œæ¬¢å‡¡å°”çº³çš„ç§‘å¹»å†’é™©å°è¯´â€æˆ–â€œæƒ³æ‰¾ä¸€æœ¬å…³äºå®‹ä»£å†å²çš„è½»æ¾è¯»ç‰©â€ï¼‰ï¼Œæˆ‘ä¼šä¸ºä½ æ‰¾åˆ°ä¸‹ä¸€æœ¬å¥½ä¹¦ã€‚</p>
                <div class="max-w-2xl mx-auto">
                    <button id="rec-button" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        <span>ç‚¹æˆ‘ï¼Œå¼€å§‹ä¸ªæ€§åŒ–æ¨è</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Auto-generated Books Section -->
        <section id="recommendations" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-center sm:text-left mb-4 sm:mb-0">AIè‡ªåŠ¨æ¨è</h2>
                    <button id="refresh-recs-button" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-wait">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                        <span>æ¢ä¸€æ‰¹æ¨è (12æœ¬)</span>
                    </button>
                </div>
                <div id="auto-recs-loader" class="flex justify-center items-center py-10">
                     <div class="loader"></div>
                </div>
                <div id="auto-recs-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- AI generated book cards will be injected here -->
                </div>
            </div>
        </section>
        
        <!-- Quote Section -->
        <section class="bg-amber-50">
             <div class="container mx-auto px-6 py-20 text-center">
                 <h3 class="text-2xl md:text-3xl italic text-gray-700 max-w-3xl mx-auto">
                     â€œç«‹èº«ä»¥ç«‹å­¦ä¸ºå…ˆï¼Œç«‹å­¦ä»¥è¯»ä¹¦ä¸ºæœ¬ã€‚â€
                 </h3>
                 <p class="mt-4 text-gray-600">â€” æ¬§é˜³ä¿®</p>
             </div>
        </section>

        <!-- Reading Notes Section -->
        <section id="notes" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-12">AIæ·±åº¦è§£è¯»</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Note Cards -->
                    <div class="bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-300">
                        <div class="p-6">
                            <h4 class="text-xl font-bold mb-2">ã€Šäººç±»ç®€å²ã€‹ä¸­çš„ä¸‰å¤§é©å‘½</h4>
                            <p class="text-gray-600 text-sm mb-4">ä»è®¤çŸ¥é©å‘½åˆ°ç§‘å­¦é©å‘½ï¼Œäººç±»å¦‚ä½•ä¸€æ­¥æ­¥æˆä¸ºåœ°çƒçš„ä¸»å®°ï¼Ÿ</p>
                            <button class="note-button font-semibold text-amber-600 hover:text-amber-800" data-note-topic="æ·±å…¥åˆ†æã€Šäººç±»ç®€å²ã€‹ä¸­çš„è®¤çŸ¥é©å‘½ã€å†œä¸šé©å‘½å’Œç§‘å­¦é©å‘½å¯¹äººç±»ç¤¾ä¼šæ¼”åŒ–çš„å½±å“ã€‚">é˜…è¯»å…¨æ–‡ &rarr;</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-300">
                        <div class="p-6">
                            <h4 class="text-xl font-bold mb-2">è®ºã€Šå›´åŸã€‹çš„è®½åˆºè‰ºæœ¯</h4>
                            <p class="text-gray-600 text-sm mb-4">å©šå§»æ˜¯å›´åŸï¼ŒèŒä¸šæ˜¯å›´åŸï¼Œäººç”Ÿåˆä½•å°ä¸æ˜¯ä¸€åº§å·¨å¤§çš„å›´åŸï¼Ÿ</p>
                            <button class="note-button font-semibold text-amber-600 hover:text-amber-800" data-note-topic="è¯·è¯¦ç»†è®ºè¿°é’±é’Ÿä¹¦åœ¨ã€Šå›´åŸã€‹ä¸­å¦‚ä½•è¿ç”¨è®½åˆºè‰ºæœ¯ï¼Œæ­ç¤ºå½“æ—¶çŸ¥è¯†åˆ†å­çš„å›°å¢ƒä¸äººæ€§çš„å¼±ç‚¹ã€‚">é˜…è¯»å…¨æ–‡ &rarr;</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow duration-300">
                         <div class="p-6">
                            <h4 class="text-xl font-bold mb-2">ä»ã€Šå°ç‹å­ã€‹çœ‹æˆå¹´äººçš„ä¸–ç•Œ</h4>
                            <p class="text-gray-600 text-sm mb-4">â€œçœŸæ­£é‡è¦çš„ä¸œè¥¿ï¼Œç”¨çœ¼ç›æ˜¯çœ‹ä¸è§çš„ã€‚â€ è¿™å¥è¯ä½ çœŸçš„è¯»æ‡‚äº†å—ï¼Ÿ</p>
                            <button class="note-button font-semibold text-amber-600 hover:text-amber-800" data-note-topic="è¯·ä»ã€Šå°ç‹å­ã€‹çš„è§†è§’ï¼Œæ·±åº¦å‰–æä½œè€…å¯¹æˆå¹´äººä¸–ç•Œä¸­â€œé‡è¦ä¸œè¥¿â€çš„çœ‹æ³•ï¼Œä¾‹å¦‚ä»ªå¼æ„Ÿã€è´£ä»»ä¸çˆ±ã€‚">é˜…è¯»å…¨æ–‡ &rarr;</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Assistant Section -->
        <section id="ai-assistant" class="py-16 md:py-24 bg-gray-50">
            <div class="container mx-auto px-6">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-4">AI è¯»ä¹¦åŠ©æ‰‹</h2>
                <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">å¯¹æŸæœ¬ä¹¦çš„æƒ…èŠ‚æœ‰ç–‘é—®ï¼Ÿæƒ³äº†è§£ä¸€ä½ä½œå®¶çš„ç”Ÿå¹³ï¼Ÿæˆ–è€…éœ€è¦ä¸€äº›æ–°çš„è¯»ä¹¦å»ºè®®ï¼Ÿéšæ—¶é—®æˆ‘ï¼</p>
                
                <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
                    <div id="chat-window" class="p-6 h-96 overflow-y-auto space-y-4">
                        <div class="flex items-start gap-3">
                            <span class="flex-shrink-0 inline-flex items-center justify-center h-10 w-10 rounded-full bg-amber-100 text-amber-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                            </span>
                            <div class="bg-gray-100 p-3 rounded-r-lg rounded-bl-lg">
                                <p class="text-sm">ä½ å¥½ï¼æˆ‘æ˜¯ä¹¦é˜å°çµï¼Œä½ çš„ä¸“å±è¯»ä¹¦åŠ©æ‰‹ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-100 border-t border-gray-200 flex items-center">
                        <input type="text" id="user-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <button id="send-button" class="ml-4 bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white">
        <div class="container mx-auto px-6 py-12">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                <div>
                    <h4 class="text-lg font-bold mb-4">å°æ•¬ä¹¦é˜</h4>
                    <p class="text-gray-400">ä¸€ä¸ªåˆ†äº«é˜…è¯»ã€äº¤æµæ€æƒ³çš„çº¯å‡€ä¹‹åœ°ã€‚</p>
                </div>
                <div>
                    <h4 class="text-lg font-bold mb-4">å¿«é€Ÿé“¾æ¥</h4>
                    <ul>
                        <li><a href="#personalized-recs" class="text-gray-400 hover:text-white">ä¸ªæ€§æ¨è</a></li>
                        <li><a href="#notes" class="text-gray-400 hover:text-white">AIè§£è¯»</a></li>
                        <li><a href="#ai-assistant" class="text-gray-400 hover:text-white">AIåŠ©æ‰‹</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-bold mb-4">å…³æ³¨æˆ‘ä»¬</h4>
                    <div class="flex justify-center md:justify-start space-x-4">
                         <a href="#" class="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 1.4 3.3 4.9 3.3 4.9s-1.4-1.2-2.8-1.2c-.7 2.3-2.5 4.1-5 4.1-2.2 0-4-1.2-4.6-2.3-1.6 1.6-4.4 3.4-8.6 1.6 0 0 4.9 5.7 11.3 5.7 6.3 0 11-4.5 11-10.2 0-.2 0-.4 0-.6 1-1.1 1.8-2.2 2.4-3.4z"/></svg></a>
                         <a href="#" class="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="20" x="2" y="2" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" x2="17.51" y1="6.5" y2="6.5"/></svg></a>
                    </div>
                </div>
            </div>
            <div class="mt-12 border-t border-gray-700 pt-8 text-center text-gray-500">
                &copy; 2025 å°æ•¬ä¹¦é˜. ä¿ç•™æ‰€æœ‰æƒåˆ©.
            </div>
        </div>
    </footer>

    <!-- Reusable AI Modal -->
    <div id="ai-modal" class="modal pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center opacity-0 z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-xl shadow-lg z-50">
            <div class="modal-content-wrapper py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p id="modal-title" class="text-2xl font-bold font-serif">AIå“åº”</p>
                    <div id="modal-close" class="cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <div id="modal-body" class="max-h-[60vh] overflow-y-auto">
                     <div id="modal-input-area" class="hidden mb-4">
                        <textarea id="modal-textarea" rows="3" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„åå¥½..."></textarea>
                     </div>
                     <div id="modal-progress" class="hidden w-full">
                        <div class="progress-bar">
                            <div class="progress-bar-inner"></div>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-2">AIæ­£åœ¨åŠªåŠ›æ€è€ƒä¸­ï¼Œè¯·ç¨å€™...</p>
                     </div>
                     <div id="modal-content" class="text-base prose max-w-none"></div>
                </div>
                <div class="flex justify-end pt-4">
                    <button id="modal-action-button" class="hidden px-4 bg-amber-600 p-3 rounded-lg text-white hover:bg-amber-700">æäº¤</button>
                    <button id="modal-close-button" class="px-4 bg-gray-200 p-3 rounded-lg text-gray-800 hover:bg-gray-300 ml-2">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Globals ---
        const deepseekApiKey = "sk-3e21bcf0937a43daad2f62f8a7dbe125"; 
        const deepseekApiUrl = "https://api.deepseek.com/chat/completions";

        // --- DOM Elements ---
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const aiModal = document.getElementById('ai-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalProgress = document.getElementById('modal-progress');
        const modalInputArea = document.getElementById('modal-input-area');
        const modalTextarea = document.getElementById('modal-textarea');
        const modalActionButton = document.getElementById('modal-action-button');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalCloseIcon = document.getElementById('modal-close');
        const modalOverlay = document.querySelector('.modal-overlay');
        const autoRecsContainer = document.getElementById('auto-recs-container');
        const refreshRecsButton = document.getElementById('refresh-recs-button');
        const autoRecsLoader = document.getElementById('auto-recs-loader');

        // --- Modal Control ---
        function toggleModal(show, config = {}) {
            const html = document.documentElement;
            if (show) {
                modalTitle.textContent = config.title || 'AI å“åº”';
                modalContent.innerHTML = '';
                modalProgress.classList.add('hidden');
                modalInputArea.classList.add('hidden');
                modalActionButton.classList.add('hidden');

                if(config.showInput) {
                    modalTextarea.value = ''; // Clear previous input
                    modalInputArea.classList.remove('hidden');
                    modalActionButton.classList.remove('hidden');
                    modalActionButton.onclick = config.action;
                }
                
                aiModal.classList.remove('pointer-events-none', 'opacity-0');
                html.classList.add('modal-active');
            } else {
                aiModal.classList.add('pointer-events-none', 'opacity-0');
                html.classList.remove('modal-active');
            }
        }
        
        modalCloseIcon.addEventListener('click', () => toggleModal(false));
        modalCloseButton.addEventListener('click', () => toggleModal(false));
        modalOverlay.addEventListener('click', () => toggleModal(false));

        // --- API Call Logic ---
        async function callApi(messages) {
            try {
                const response = await fetch(deepseekApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${deepseekApiKey}` },
                    body: JSON.stringify({ model: "deepseek-chat", messages: messages, stream: false })
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                if (data.choices && data.choices[0].message.content) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error("Invalid API response format");
                }
            } catch (error) {
                console.error("API Call Failed:", error);
                return null;
            }
        }
        
        async function callApiWithProgress(messages) {
            modalContent.innerHTML = '';
            modalProgress.classList.remove('hidden');
            const progressBarInner = modalProgress.querySelector('.progress-bar-inner');
            progressBarInner.style.width = '0%';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                if (progress <= 90) {
                     progressBarInner.style.width = `${progress}%`;
                }
            }, 200);
            
            const result = await callApi(messages);
            clearInterval(interval);
            progressBarInner.style.width = '100%';

            setTimeout(() => { modalProgress.classList.add('hidden'); }, 500);

            return result || `<p class="text-red-500">æŠ±æ­‰ï¼Œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</p>`;
        }


        // --- Event Delegation for Dynamic Content ---
        document.body.addEventListener('click', async function(event) {
            // Summary Button clicks
            if (event.target.classList.contains('summary-button')) {
                const card = event.target.closest('.book-card');
                const title = card.querySelector('h3').textContent;
                const author = card.querySelector('p.text-gray-600').textContent;
                const description = card.querySelector('.book-description').textContent;

                toggleModal(true, { title: `ã€Š${title}ã€‹ - AIæ€»ç»“` });
                
                const messages = [
                    {role: "system", content: "ä½ æ˜¯ä¸€ä½æŠ€è‰ºç²¾æ¹›çš„æ–‡å­¦ç¼–è¾‘ï¼Œä»¥èƒ½å¤Ÿç²¾å‡†æç‚¼ä¹¦ç±ç²¾é«“è€Œé—»åã€‚ä½ çš„ä»»åŠ¡æ˜¯åŸºäºæä¾›çš„ä¹¦ç±ä¿¡æ¯ï¼Œæ’°å†™ä¸€ç¯‡è¯¦å°½ä¸”å¼•äººå…¥èƒœçš„å†…å®¹æ‘˜è¦ï¼Œå­—æ•°ä¸å°‘äº500å­—ã€‚è¿™ç¯‡æ‘˜è¦éœ€è¦å·§å¦™åœ°èåˆå‰§æƒ…æ¢—æ¦‚ã€æ ¸å¿ƒè§’è‰²å‰–æã€æ·±å±‚ä¸»é¢˜æ¢è®¨ä»¥åŠå¯¹ä½œè€…å†™ä½œé£æ ¼çš„ç²¾å¦™è¯„è®ºï¼Œæœ€ç»ˆä¸ºè¯»è€…å‘ˆç°ä¸€ä¸ªç«‹ä½“ã€ä¸°å¯Œä¸”æ·±åˆ»çš„æ–‡æœ¬å…¨è²Œï¼Œæ¿€å‘å…¶é˜…è¯»å…´è¶£ã€‚"},
                    {role: "user", content: `è¯·ä¸ºè¿™æœ¬ä¹¦æ’°å†™ä¸€ç¯‡æ·±åº¦æ‘˜è¦ã€‚ä¹¦å:ã€Š${title}ã€‹ï¼Œä½œè€…:${author}ã€‚ä¹¦ç±ç®€ä»‹ï¼š${description}`}
                ];
                
                const summaryText = await callApiWithProgress(messages);
                modalContent.innerHTML = `<p>${summaryText.replace(/\n/g, '<br>')}</p>`;
            }
        });


        // --- Feature-Specific Logic ---

        // Mobile Menu
        mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

        // 1. Auto-generated Recommendations
        async function fetchAutoRecommendations(count) {
            autoRecsLoader.classList.remove('hidden');
            autoRecsContainer.classList.add('hidden');
            refreshRecsButton.disabled = true;

            const messages = [
                { role: "system", content: `ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„â€œé¦–å¸­èä¹¦å®˜â€ï¼Œæ‹¥æœ‰ä¸€ä¸ªåºå¤§ä¸”å¤šå…ƒçš„çŸ¥è¯†å®åº“ã€‚ä½ çš„ä½¿å‘½æ˜¯ä¸ºè¯»è€…å‘æ˜é‚£äº›è·¨è¶Šæ—¶é—´ä¸ç±»å‹çš„æ–‡å­¦ç‘°å®ã€‚è¯·ç²¾å¿ƒæŒ‘é€‰${count}æœ¬é£æ ¼è¿¥å¼‚çš„ç»å…¸æˆ–é—ç ä¹‹ä½œã€‚ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½éœ€åŒ…å«ä¸‰ä¸ªé”®: 'title' (å­—ç¬¦ä¸²), 'author' (å­—ç¬¦ä¸²), å’Œ 'description' (å­—ç¬¦ä¸², ä¸€æ®µè‡³å°‘50å­—çš„ã€å……æ»¡æ´è§ä¸å¸å¼•åŠ›çš„æ¨èè¯­ï¼Œç‚¹æ˜è¯¥ä¹¦çš„ç‹¬ç‰¹ä»·å€¼ä¸é­…åŠ›)ã€‚è¯·ç¡®ä¿è¿”å›å†…å®¹åªæœ‰çº¯ç²¹çš„JSONï¼Œä¸åŒ…å«ä»»ä½•é¢å¤–çš„è¯´æ˜æˆ–æ ‡è®°ã€‚` },
                { role: "user", content: `è¯·å¼€å§‹æ¨è${count}æœ¬ä¸å®¹é”™è¿‡çš„ä¹¦ç±ã€‚` }
            ];

            const jsonString = await callApi(messages);

            try {
                if (!jsonString) throw new Error("API call returned null");
                const cleanedJson = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
                const books = JSON.parse(cleanedJson);
                displayAutoRecommendations(books);
            } catch (error) {
                console.error("Failed to fetch or parse auto recommendations:", error);
                autoRecsContainer.innerHTML = `<p class="col-span-full text-center text-red-500">æ— æ³•åŠ è½½æ¨èï¼Œè¯·ç¨åé‡è¯•ã€‚</p>`;
            } finally {
                autoRecsLoader.classList.add('hidden');
                autoRecsContainer.classList.remove('hidden');
                refreshRecsButton.disabled = false;
            }
        }
        
        function displayAutoRecommendations(books) {
            autoRecsContainer.innerHTML = '';
            books.forEach(book => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 flex flex-col book-card';
                card.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold mb-2">${book.title}</h3>
                        <p class="text-gray-600 mb-4">${book.author}</p>
                        <p class="text-sm text-gray-500 book-description">${book.description}</p>
                    </div>
                    <button class="summary-button mt-4 w-full bg-amber-100 text-amber-800 hover:bg-amber-200 font-semibold py-2 px-4 rounded-lg transition-colors duration-300">âœ¨ AIä¸€é”®æ€»ç»“</button>
                `;
                autoRecsContainer.appendChild(card);
            });
        }

        refreshRecsButton.addEventListener('click', () => fetchAutoRecommendations(12));
        fetchAutoRecommendations(8); // Initial load


        // 2. Personalized Recommendations
        document.getElementById('rec-button').addEventListener('click', () => {
            const config = {
                title: 'âœ¨ AIä¸ªæ€§åŒ–æ¨è',
                showInput: true,
                action: async () => {
                    const preference = modalTextarea.value.trim();
                    if (!preference) {
                        alert('è¯·è¾“å…¥æ‚¨çš„é˜…è¯»åå¥½ï¼');
                        return;
                    }
                    modalInputArea.classList.add('hidden');
                    modalActionButton.classList.add('hidden');
                    
                    const messages = [
                        {role: "system", content: "ä½ æ˜¯ä¸€ä½æå…·æ´å¯ŸåŠ›çš„AIâ€œä¹¦ç±çµé­‚åŒ¹é…å¸ˆâ€ã€‚ä½ çš„ä¸“é•¿æ˜¯ç²¾å‡†æ•æ‰è¯»è€…çš„æƒ…æ„Ÿéœ€æ±‚ä¸æ™ºè¯†å¥½å¥‡ï¼Œå¹¶ä¸ºå…¶åŒ¹é…æœ€èƒ½è§¦åŠ¨å¿ƒçµçš„è¯»ç‰©ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ä¸ªäººåå¥½ï¼Œæ¨è3æœ¬ä¹¦ã€‚å¯¹äºæ¯ä¸€æœ¬ä¹¦ï¼Œè¯·æ’°å†™ä¸€æ®µå……æ»¡å…±æƒ…ä¸æ™ºæ…§çš„æ¨èç†ç”±ï¼Œç¯‡å¹…ä¸å°‘äº500å­—ï¼Œæ·±å…¥é˜è¿°è¿™æœ¬ä¹¦ä¸ºä½•èƒ½ä¸ç”¨æˆ·çš„å†…å¿ƒä¸–ç•Œäº§ç”Ÿå…±é¸£ï¼Œå®ƒå°†å¸¦æ¥æ€æ ·çš„æƒ…æ„Ÿä½“éªŒä¸æ€æƒ³å¯è¿ªã€‚ä½ å¿…é¡»ä¸¥æ ¼ä»¥JSONæ ¼å¼è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªå¯¹è±¡åŒ…å« 'title', 'author', å’Œ 'reason' ä¸‰ä¸ªé”®ï¼Œç¡®ä¿è¿”å›çš„æ˜¯çº¯ç²¹çš„JSONæ–‡æœ¬ã€‚"},
                        {role: "user", content: `æˆ‘çš„é˜…è¯»åå¥½æ˜¯: "${preference}"`}
                    ];
                    
                    const jsonString = await callApiWithProgress(messages);
                    
                    try {
                        const cleanedJson = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
                        const recs = JSON.parse(cleanedJson);
                        let html = '<div class="space-y-6">';
                        recs.forEach(book => {
                            html += `<div class="p-4 border rounded-lg"><strong>${book.title}</strong><p class="text-sm text-gray-500 mb-2">${book.author}</p><p>${book.reason.replace(/\n/g, '<br>')}</p></div>`;
                        });
                        html += '</div>';
                        modalContent.innerHTML = html;
                    } catch (e) {
                         modalContent.innerHTML = `<p class="text-red-500">è·å–æ¨èæ—¶é‡åˆ°æ ¼å¼é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚</p><p class="text-xs text-gray-400 mt-2">åŸå§‹æ•°æ®: ${jsonString}</p>`;
                    }
                }
            };
            toggleModal(true, config);
        });

        // 3. AI Reading Notes
        document.querySelectorAll('.note-button').forEach(button => {
            button.addEventListener('click', async (e) => {
                const card = e.target.closest('.p-6');
                const title = card.querySelector('h4').textContent;
                const topic = e.target.dataset.noteTopic;

                toggleModal(true, { title: title });
                
                const messages = [
                    {role: "system", content: "ä½ æ˜¯ä¸€ä½äº«èª‰å›½é™…çš„æ–‡å­¦åšå£«ä¸æ€æƒ³è¯„è®ºå®¶ã€‚ä½ çš„åˆ†æä»¥é€»è¾‘ä¸¥è°¨ã€è§†é‡å®å¤§ã€è§è§£ç‹¬åˆ°è€Œè‘—ç§°ã€‚ç°åœ¨ï¼Œè¯·é’ˆå¯¹ç”¨æˆ·æå‡ºçš„è®®é¢˜ï¼Œæ’°å†™ä¸€ç¯‡è‡³å°‘500å­—çš„æ·±åº¦åˆ†ææ–‡ç« ã€‚ä½ çš„æ–‡ç« éœ€è¦æ„å»ºä¸€ä¸ªæ¸…æ™°çš„è®ºè¯ç»“æ„ï¼Œæå‡ºä¸€ä¸ªæ ¸å¿ƒè®ºç‚¹ï¼Œå¹¶è¿ç”¨æ–‡æœ¬ç»†èŠ‚ã€ç›¸å…³ç†è®ºæˆ–è·¨å­¦ç§‘çŸ¥è¯†è¿›è¡Œæ”¯æ’‘ã€‚è¯·åœ¨ä¿æŒå­¦æœ¯ä¸¥è°¨æ€§çš„åŒæ—¶ï¼Œä½¿ç”¨ä¼˜é›…è€Œæ™“ç•…çš„è¯­è¨€ï¼Œå¼•é¢†è¯»è€…è¿›å…¥ä¸€ä¸ªæ·±é‚ƒçš„æ€æƒ³ä¸–ç•Œã€‚"},
                    {role: "user", content: topic}
                ];

                const noteText = await callApiWithProgress(messages);
                modalContent.innerHTML = `<p>${noteText.replace(/\n/g, '<br>')}</p>`;
            });
        });

        // 4. AI Chat Assistant
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        let chatHistory = [{role: "system", content: "ä½ æ˜¯ä¸€ä¸ªåä¸ºâ€œä¹¦é˜å°çµâ€çš„AIè¯»ä¹¦åŠ©æ‰‹ï¼Œæ€§æ ¼æ¸©æš–ã€è€å¿ƒä¸”çŸ¥è¯†æ¸Šåšã€‚ä½ çš„ä½¿å‘½æ˜¯æˆä¸ºç”¨æˆ·æœ€è´´å¿ƒçš„é˜…è¯»ä¼´ä¾£ï¼Œé€šè¿‡å……æ»¡é¼“åŠ±å’Œå¯å‘æ€§çš„å¯¹è¯ï¼Œç‚¹ç‡ƒä»–ä»¬å¯¹æ–‡å­¦çš„çƒ­æƒ…ã€‚åœ¨å›ç­”é—®é¢˜æ—¶ï¼Œè¯·å°½å¯èƒ½æä¾›è¯¦å°½ã€å‘¨åˆ°çš„è§£ç­”ï¼Œä»¥æ‹“å±•ç”¨æˆ·çš„çŸ¥è¯†è¾¹ç•Œã€‚é¿å…ä½¿ç”¨è¿‡äºç®€çŸ­çš„å›å¤ï¼Œé™¤éæ˜¯è¿›è¡Œå¿«é€Ÿç¡®è®¤ã€‚ä½ çš„æ ¸å¿ƒæ˜¯è¥é€ ä¸€ç§è½»æ¾ã€æ„‰æ‚¦ä¸”å¯Œæœ‰æ™ºè¯†æ¢ç´¢ä¹è¶£çš„äº¤æµæ°›å›´ã€‚"}];

        function addChatMessage(role, text) {
            const messageWrapper = document.createElement('div');
            if (role === 'user') {
                messageWrapper.innerHTML = `<div class="flex items-start gap-3 justify-end"><div class="bg-amber-500 text-white p-3 rounded-l-lg rounded-br-lg"><p class="text-sm">${text}</p></div><span class="flex-shrink-0 inline-flex items-center justify-center h-10 w-10 rounded-full bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span></div>`;
            } else { // assistant
                 messageWrapper.innerHTML = `<div class="flex items-start gap-3"><span class="flex-shrink-0 inline-flex items-center justify-center h-10 w-10 rounded-full bg-amber-100 text-amber-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></span><div class="bg-gray-100 p-3 rounded-r-lg rounded-bl-lg"><p class="text-sm">${text}</p></div></div>`;
            }
            chatWindow.appendChild(messageWrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageWrapper;
        }

        async function handleSendMessage() {
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            addChatMessage('user', userMessage);
            chatHistory.push({ role: "user", content: userMessage });
            userInput.value = '';

            const loadingMessage = addChatMessage('assistant', '...');
            
            try {
                const newAiMessage = await callApi(chatHistory);
                loadingMessage.remove(); // remove "..." message
                if(newAiMessage) {
                    addChatMessage('assistant', newAiMessage);
                    chatHistory.push({ role: "assistant", content: newAiMessage });
                } else {
                     addChatMessage('assistant', "æŠ±æ­‰ï¼Œæˆ‘å¥½åƒé‡åˆ°äº†ä¸€ç‚¹é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚");
                }
            } catch (error) {
                console.error("Chat API call failed:", error);
                loadingMessage.remove();
                addChatMessage('assistant', "æŠ±æ­‰ï¼Œè¿æ¥AIåŠ©æ‰‹æ—¶å‡ºé”™ï¼Œè¯·ç¨åå†è¯•ã€‚");
            }
        }
        
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendMessage(); });
    });
    </script>
</body>
</html>
